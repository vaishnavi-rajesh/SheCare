<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SheCare - Period Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #ffeef8 0%, #ffe5f0 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .navbar {
            background: white;
            padding: 15px 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .navbar h1 {
            color: #d63384;
            font-size: 24px;
        }
        
        .nav-btn {
            padding: 10px 20px;
            background: #d63384;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
            text-decoration: none;
            display: inline-block;
            margin-left: 10px;
        }
        
        .nav-btn:hover {
            background: #b82b6e;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        /* Current Phase Card */
        .phase-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .phase-card h2 {
            color: white;
            margin-bottom: 15px;
            font-size: 24px;
        }
        
        .phase-name {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .phase-description {
            font-size: 16px;
            opacity: 0.95;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .phase-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .phase-stat {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .phase-stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .phase-stat-value {
            font-size: 24px;
            font-weight: bold;
        }
        
        /* Calendar Styles */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .calendar-nav button {
            background: #f0f0f0;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .calendar-nav button:hover {
            background: #e0e0e0;
        }
        
        .month-year {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        
        .calendar-day-header {
            text-align: center;
            padding: 10px;
            font-weight: bold;
            color: #666;
            font-size: 14px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            position: relative;
            transition: all 0.3s;
        }
        
        .calendar-day:hover {
            background: #f8f8f8;
        }
        
        .calendar-day.today {
            border: 2px solid #d63384;
            font-weight: bold;
        }
        
        .calendar-day.period {
            background: #dc3545;
            color: white;
            font-weight: 600;
        }
        
        .calendar-day.predicted {
            background: #ffc0cb;
            color: #d63384;
        }
        
        .calendar-day.fertile {
            background: #28a745;
            color: white;
        }
        
        .calendar-day.ovulation {
            background: #ffd700;
            color: #333;
            font-weight: bold;
        }
        
        .calendar-day.follicular {
            background: #17a2b8;
            color: white;
        }
        
        .calendar-day.luteal {
            background: #ffc107;
            color: #333;
        }
        
        .calendar-day.other-month {
            color: #ccc;
        }
        
        /* Stats Card */
        .stats-grid {
            display: grid;
            gap: 15px;
        }
        
        .stat-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }
        
        /* Log Form */
        .log-form {
            display: grid;
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }
        
        input, select, textarea {
            padding: 10px;
            border: 2px solid #f0f0f0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #d63384;
        }
        
        .symptoms-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .symptom-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .symptom-checkbox input[type="checkbox"] {
            width: auto;
        }
        
        button[type="submit"] {
            padding: 12px;
            background: #d63384;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        button[type="submit"]:hover {
            background: #b82b6e;
        }
        
        /* Period History */
        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .history-item {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #d63384;
        }
        
        .history-date {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .history-details {
            font-size: 13px;
            color: #666;
        }
        
        /* Legend */
        .legend {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #f0f0f0;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .insights-card {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .insights-card h3 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .insights-card ul {
            margin-left: 20px;
            color: #856404;
        }
        
        .insights-card li {
            margin-bottom: 8px;
        }
        
        @media (max-width: 968px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .phase-stats {
                grid-template-columns: 1fr;
            }
            
            .navbar {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>ü©∏ Period Tracker</h1>
        <div>
            <a href="/dashboard" class="nav-btn">Dashboard</a>
            <a href="#" onclick="logout()" class="nav-btn">Logout</a>
        </div>
    </div>

    <div class="container">
        <div id="message" class="message"></div>
        
        <!-- Current Cycle Phase -->
        <div class="phase-card" id="phaseCard" style="display: none;">
            <h2>Your Current Cycle Phase</h2>
            <div class="phase-name" id="phaseName">-</div>
            <div class="phase-description" id="phaseDescription">-</div>
            <div class="phase-stats">
                <div class="phase-stat">
                    <div class="phase-stat-label">Days in Phase</div>
                    <div class="phase-stat-value" id="daysInPhase">-</div>
                </div>
                <div class="phase-stat">
                    <div class="phase-stat-label">Days Since Period</div>
                    <div class="phase-stat-value" id="daysSincePeriod">-</div>
                </div>
                <div class="phase-stat">
                    <div class="phase-stat-label">Next Period In</div>
                    <div class="phase-stat-value" id="daysUntilPeriod">-</div>
                </div>
            </div>
        </div>
        
        <div class="grid">
            <!-- Calendar -->
            <div class="card">
                <div class="calendar-header">
                    <h2>Calendar</h2>
                    <div class="calendar-nav">
                        <button onclick="previousMonth()">‚Üê Prev</button>
                        <span class="month-year" id="monthYear"></span>
                        <button onclick="nextMonth()">Next ‚Üí</button>
                    </div>
                </div>
                
                <div class="calendar" id="calendar"></div>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #dc3545;"></div>
                        <span>Period</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #17a2b8;"></div>
                        <span>Follicular</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffd700;"></div>
                        <span>Ovulation</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #28a745;"></div>
                        <span>Fertile Window</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffc107;"></div>
                        <span>Luteal</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffc0cb;"></div>
                        <span>Predicted</span>
                    </div>
                </div>
                
                <div class="insights-card" id="insightsCard" style="display: none;">
                    <h3>üìä Cycle Insights</h3>
                    <ul id="insightsList"></ul>
                </div>
            </div>
            
            <!-- Stats -->
            <div class="card">
                <h2>Your Stats</h2>
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-item">
                        <div class="stat-label">Average Cycle</div>
                        <div class="stat-value" id="avgCycle">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Last Period</div>
                        <div class="stat-value" id="lastPeriod" style="font-size: 16px;">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Next Expected</div>
                        <div class="stat-value" id="nextPeriod" style="font-size: 16px;">-</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="grid">
            <!-- Log Period Form -->
            <div class="card">
                <h2>Log Your Period</h2>
                <form class="log-form" onsubmit="logPeriod(event)">
                    <div class="form-group">
                        <label for="startDate">Start Date *</label>
                        <input type="date" id="startDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="endDate">End Date (optional)</label>
                        <input type="date" id="endDate">
                    </div>
                    
                    <div class="form-group">
                        <label for="flowIntensity">Flow Intensity</label>
                        <select id="flowIntensity">
                            <option value="">Select...</option>
                            <option value="light">Light</option>
                            <option value="medium">Medium</option>
                            <option value="heavy">Heavy</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Symptoms</label>
                        <div class="symptoms-grid">
                            <div class="symptom-checkbox">
                                <input type="checkbox" id="cramps" value="cramps">
                                <label for="cramps" style="margin: 0;">Cramps</label>
                            </div>
                            <div class="symptom-checkbox">
                                <input type="checkbox" id="headache" value="headache">
                                <label for="headache" style="margin: 0;">Headache</label>
                            </div>
                            <div class="symptom-checkbox">
                                <input type="checkbox" id="bloating" value="bloating">
                                <label for="bloating" style="margin: 0;">Bloating</label>
                            </div>
                            <div class="symptom-checkbox">
                                <input type="checkbox" id="moodSwings" value="mood_swings">
                                <label for="moodSwings" style="margin: 0;">Mood Swings</label>
                            </div>
                            <div class="symptom-checkbox">
                                <input type="checkbox" id="fatigue" value="fatigue">
                                <label for="fatigue" style="margin: 0;">Fatigue</label>
                            </div>
                            <div class="symptom-checkbox">
                                <input type="checkbox" id="backPain" value="back_pain">
                                <label for="backPain" style="margin: 0;">Back Pain</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="notes">Notes (optional)</label>
                        <textarea id="notes" rows="3" placeholder="Any additional notes..."></textarea>
                    </div>
                    
                    <button type="submit">Log Period</button>
                </form>
            </div>
            
            <!-- Period History -->
            <div class="card">
                <h2>Period History</h2>
                <div class="history-list" id="historyList">
                    <p style="text-align: center; color: #999;">No periods logged yet</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentDate = new Date();
        let periodData = [];
        let predictions = [];
        let currentPhase = null;
        const userId = localStorage.getItem("user_id");

        if (!userId) {
            window.location.href = "/";
        }

        // Initialize
        window.onload = function() {
            loadData();
        };

        async function loadData() {
            await loadPeriodHistory();
            await loadPredictions();
            await loadStats();
            await loadCurrentPhase();
            renderCalendar();
            generateInsights();
        }

        async function loadCurrentPhase() {
            try {
                const response = await fetch(`/period/current-phase/${userId}`);
                currentPhase = await response.json();
                
                if (currentPhase.current_phase) {
                    document.getElementById("phaseCard").style.display = "block";
                    document.getElementById("phaseName").textContent = currentPhase.current_phase;
                    document.getElementById("phaseDescription").textContent = currentPhase.description;
                    document.getElementById("daysInPhase").textContent = currentPhase.days_in_phase || "-";
                    document.getElementById("daysSincePeriod").textContent = currentPhase.days_since_last_period;
                    document.getElementById("daysUntilPeriod").textContent = 
                        currentPhase.days_until_next_period > 0 ? currentPhase.days_until_next_period : "Late";
                    
                    // Set phase card color
                    const phaseCard = document.getElementById("phaseCard");
                    phaseCard.style.background = `linear-gradient(135deg, ${currentPhase.phase_color} 0%, ${adjustColor(currentPhase.phase_color, -20)} 100%)`;
                }
            } catch (error) {
                console.error("Error loading current phase:", error);
            }
        }

        function adjustColor(color, percent) {
            const num = parseInt(color.replace("#",""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 
                + (G<255?G<1?0:G:255)*0x100 + (B<255?B<1?0:B:255))
                .toString(16).slice(1);
        }

        async function loadPeriodHistory() {
            try {
                const response = await fetch(`/period/history/${userId}`);
                periodData = await response.json();
                renderHistory();
            } catch (error) {
                console.error("Error loading period history:", error);
            }
        }

        async function loadPredictions() {
            try {
                const response = await fetch(`/period/predictions/${userId}`);
                const data = await response.json();
                predictions = data.predictions || [];
            } catch (error) {
                console.error("Error loading predictions:", error);
            }
        }

        async function loadStats() {
            try {
                const response = await fetch(`/period/stats/${userId}`);
                const stats = await response.json();
                
                document.getElementById("avgCycle").textContent = 
                    stats.avg_cycle_length ? `${stats.avg_cycle_length} days` : "-";
                document.getElementById("lastPeriod").textContent = 
                    stats.last_period ? formatDate(stats.last_period) : "-";
                
                if (predictions.length > 0) {
                    document.getElementById("nextPeriod").textContent = 
                        formatDate(predictions[0].predicted_start);
                }
            } catch (error) {
                console.error("Error loading stats:", error);
            }
        }

        function generateInsights() {
            if (periodData.length < 2) return;
            
            const insightsCard = document.getElementById("insightsCard");
            const insightsList = document.getElementById("insightsList");
            insightsCard.style.display = "block";
            
            let insights = [];
            
            // Cycle regularity
            const cycleLengths = periodData.map(p => p.cycle_length).filter(c => c);
            if (cycleLengths.length >= 2) {
                const variance = Math.max(...cycleLengths) - Math.min(...cycleLengths);
                if (variance <= 3) {
                    insights.push("Your cycle is very regular! This is a sign of good hormonal health.");
                } else if (variance <= 7) {
                    insights.push("Your cycle shows normal variation (within 7 days).");
                } else {
                    insights.push("Your cycle shows significant variation. Consider tracking more data or consulting a doctor.");
                }
            }
            
            // Period duration
            const durations = periodData.filter(p => p.end_date).map(p => {
                const start = new Date(p.start_date);
                const end = new Date(p.end_date);
                return Math.round((end - start) / (1000 * 60 * 60 * 24)) + 1;
            });
            
            if (durations.length > 0) {
                const avgDuration = durations.reduce((a, b) => a + b, 0) / durations.length;
                if (avgDuration < 3) {
                    insights.push("Your periods are shorter than average. Monitor if this persists.");
                } else if (avgDuration > 7) {
                    insights.push("Your periods are longer than average. Consider discussing with a healthcare provider.");
                }
            }
            
            // Common symptoms
            const allSymptoms = periodData.map(p => p.symptoms).flat();
            if (allSymptoms.length > 0) {
                const symptomCounts = {};
                allSymptoms.forEach(s => symptomCounts[s] = (symptomCounts[s] || 0) + 1);
                const mostCommon = Object.entries(symptomCounts).sort((a, b) => b[1] - a[1])[0];
                if (mostCommon) {
                    insights.push(`Most common symptom: ${mostCommon[0].replace('_', ' ')}`);
                }
            }
            
            insightsList.innerHTML = insights.map(i => `<li>${i}</li>`).join('');
        }

        function renderCalendar() {
            const calendar = document.getElementById("calendar");
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById("monthYear").textContent = 
                new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            calendar.innerHTML = '';
            
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                calendar.appendChild(header);
            });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();
            
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                const dayDiv = createDayElement(day, month - 1, year, true);
                calendar.appendChild(dayDiv);
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = createDayElement(day, month, year, false);
                calendar.appendChild(dayDiv);
            }
            
            const totalCells = calendar.children.length - 7;
            const remainingCells = (Math.ceil(totalCells / 7) * 7) - totalCells;
            for (let day = 1; day <= remainingCells; day++) {
                const dayDiv = createDayElement(day, month + 1, year, true);
                calendar.appendChild(dayDiv);
            }
        }

        function createDayElement(day, month, year, isOtherMonth) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';
            dayDiv.textContent = day;
            
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const today = new Date().toISOString().split('T')[0];
            
            if (isOtherMonth) {
                dayDiv.classList.add('other-month');
            }
            
            if (dateStr === today) {
                dayDiv.classList.add('today');
            }
            
            // Color actual logged periods and their cycle phases
            let isPeriodDay = false;
            periodData.forEach(period => {
                if (isDateInRange(dateStr, period.start_date, period.end_date)) {
                    dayDiv.classList.add('period');
                    isPeriodDay = true;
                } else if (period.cycle_length && period.start_date) {
                    // Calculate cycle phases for this period
                    const periodStart = new Date(period.start_date);
                    const currentDay = new Date(dateStr);
                    const daysSincePeriod = Math.floor((currentDay - periodStart) / (1000 * 60 * 60 * 24));
                    
                    // Only color if this date is within this cycle
                    if (daysSincePeriod > 0 && daysSincePeriod < (period.cycle_length || 28)) {
                        if (daysSincePeriod <= 5) {
                            // Days 1-5: Menstruation (already handled above)
                        } else if (daysSincePeriod <= 13) {
                            // Days 6-13: Follicular Phase
                            if (!dayDiv.classList.contains('period')) {
                                dayDiv.classList.add('follicular');
                            }
                        } else if (daysSincePeriod <= 16) {
                            // Days 14-16: Ovulation
                            if (!dayDiv.classList.contains('period')) {
                                dayDiv.classList.add('ovulation');
                            }
                        } else {
                            // Days 17+: Luteal Phase
                            if (!dayDiv.classList.contains('period')) {
                                dayDiv.classList.add('luteal');
                            }
                        }
                    }
                }
            });
            
            // Color predicted future periods and their cycle phases
            predictions.forEach(pred => {
                const predDate = new Date(pred.predicted_start);
                const currentDay = new Date(dateStr);
                const avgCycle = pred.avg_cycle_length || 28;
                
                // Days since predicted period start
                const daysSincePrediction = Math.floor((currentDay - predDate) / (1000 * 60 * 60 * 24));
                
                if (dateStr === pred.predicted_start) {
                    // Predicted period start day
                    if (!isPeriodDay) {
                        dayDiv.classList.add('predicted');
                    }
                } else if (daysSincePrediction > 0 && daysSincePrediction <= 5) {
                    // Predicted period days (1-5)
                    if (!isPeriodDay && !dayDiv.classList.contains('follicular') && !dayDiv.classList.contains('luteal')) {
                        dayDiv.classList.add('predicted');
                    }
                } else if (daysSincePrediction > 5 && daysSincePrediction <= 13) {
                    // Predicted follicular phase
                    if (!isPeriodDay && !dayDiv.classList.contains('follicular')) {
                        dayDiv.classList.add('follicular');
                    }
                } else if (daysSincePrediction > 13 && daysSincePrediction <= 16) {
                    // Predicted ovulation
                    if (!isPeriodDay && !dayDiv.classList.contains('ovulation')) {
                        dayDiv.classList.add('ovulation');
                    }
                } else if (daysSincePrediction > 16 && daysSincePrediction < avgCycle) {
                    // Predicted luteal phase
                    if (!isPeriodDay && !dayDiv.classList.contains('luteal')) {
                        dayDiv.classList.add('luteal');
                    }
                }
                
                // Fertile window
                if (isDateInRange(dateStr, pred.fertile_window_start, pred.fertile_window_end)) {
                    if (!isPeriodDay) {
                        dayDiv.classList.add('fertile');
                    }
                }
            });
            
            return dayDiv;
        }

        function isDateInRange(date, start, end) {
            if (!end) return date === start;
            return date >= start && date <= end;
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        async function logPeriod(event) {
            event.preventDefault();
            
            const symptoms = [];
            document.querySelectorAll('.symptom-checkbox input:checked').forEach(cb => {
                symptoms.push(cb.value);
            });
            
            const data = {
                user_id: parseInt(userId),
                start_date: document.getElementById("startDate").value,
                end_date: document.getElementById("endDate").value || null,
                flow_intensity: document.getElementById("flowIntensity").value || null,
                symptoms: symptoms,
                notes: document.getElementById("notes").value || null
            };
            
            try {
                const response = await fetch("/period/log", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.status === "success") {
                    showMessage("Period logged successfully!", "success");
                    document.querySelector(".log-form").reset();
                    await loadData();
                } else {
                    showMessage(result.message || "Error logging period", "error");
                }
            } catch (error) {
                showMessage("An error occurred. Please try again.", "error");
                console.error(error);
            }
        }

        function renderHistory() {
            const historyList = document.getElementById("historyList");
            
            if (periodData.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: #999;">No periods logged yet</p>';
                return;
            }
            
            let html = '';
            periodData.forEach(period => {
                const duration = period.end_date ? 
                    calculateDuration(period.start_date, period.end_date) : 'Ongoing';
                
                html += `
                    <div class="history-item">
                        <div class="history-date">${formatDate(period.start_date)}</div>
                        <div class="history-details">
                            Duration: ${duration}<br>
                            ${period.flow_intensity ? `Flow: ${period.flow_intensity}<br>` : ''}
                            ${period.cycle_length ? `Cycle Length: ${period.cycle_length} days<br>` : ''}
                            ${period.symptoms && period.symptoms.length > 0 ? 
                                `Symptoms: ${period.symptoms.join(', ')}` : ''}
                        </div>
                    </div>
                `;
            });
            
            historyList.innerHTML = html;
        }

        function calculateDuration(start, end) {
            const startDate = new Date(start);
            const endDate = new Date(end);
            const days = Math.round((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            return `${days} ${days === 1 ? 'day' : 'days'}`;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function showMessage(text, type) {
            const msgDiv = document.getElementById('message');
            msgDiv.textContent = text;
            msgDiv.className = `message ${type}`;
            msgDiv.style.display = 'block';
            setTimeout(() => {
                msgDiv.style.display = 'none';
            }, 5000);
        }

        function logout() {
            localStorage.removeItem("user_id");
            localStorage.removeItem("user_name");
            window.location.href = "/";
        }
    </script>
</body>
</html>